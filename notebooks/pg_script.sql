



-- "경기도 성남시분당구 판교동" -> "경기도 성남시 분당구 판교동"
update "실거래_상업업무용_분당구"
set    "시군구명" = replace("시군구명", '성남시분당구', '성남시 분당구')
;

update "실거래_단독다가구_분당구"
set    "시군구명" = replace("시군구명", '성남시분당구', '성남시 분당구')
;

update "실거래_공장창고_분당구"
set    "시군구명" = replace("시군구명", '성남시분당구', '성남시 분당구')
;

update "실거래_토지_분당구"
set    "시군구명" = replace("시군구명", '성남시분당구', '성남시 분당구')
;

commit;

----------------------------------------------------------------------------------------------------------------------------------------------------------------
-- [공통함수]
----------------------------------------------------------------------------------------------------------------------------------------------------------------
create or replace function "도로명체크" ("매매_도로명" TEXT, "건물_도로명주소" TEXT)
returns boolean as $$
begin
	if "매매_도로명" is null or "매매_도로명" = '' then
		return true;
	elsif "건물_도로명주소" like CONCAT('%', "매매_도로명", '%') then
		return true;
	else
		return false;
	end if;
end;
$$ language plpgsql;


----------------------------------------------------------------------------------------------------------------------------------------------------------------
-- [건축물대장]
-- 오래된 건물이라 건축물대장 최초 작성(1992년 전후) 당시 대지면적, 건폐율, 용적률 등이 전산에 입력되지 않아 기본값 0으로 남아 있는 경우가 있습니다.
-- 집합건물(아파트, 오피스텔, 상가 등)처럼 대지를 구분해 쓰지 않고 ‘대지권 비율’로만 나누는 경우, 개별 호·점포의 건축물대장 표제부에는 대지면적을 0으로 두고 등기부나 토지대장에서 대지권을 확인하게 하는 사례가 많습니다.
----------------------------------------------------------------------------------------------------------------------------------------------------------------
select * from "건축물대장" where "대지_면적" = 0;



----------------------------------------------------------------------------------------------------------------------------------------------------------------
-- [실거래_단독다가구_분당구]
--  . 거래구분 = '1' 인 매매건만 분석 대상 (전세,월세 제외)
----------------------------------------------------------------------------------------------------------------------------------------------------------------
--select "주택유형", avg("건수") as "평균매핑건수" from (
	--select  "계약년월", "번호", "주택유형", count("관리_건축물대장_PK") as "건수" from (
		select 	t.*, b.* 
		from 	"실거래_단독다가구_분당구" ts
				left outer join "건축물대장" b
				--on (t."시군구명" = b."시군구명" and t."번지" = b."번지")
				--on (t."시군구명" = b."시군구명" and t."번지" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치"))
				on (t."시군구명" = b."시군구명" and t."번지" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치") and b."주_용도_코드_명" = '단독주택')
				--on (t."시군구명" = b."시군구명" and t."번지" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치") and b."주_용도_코드_명" = '단독주택' and t."대지면적" = b."대지_면적" and t."연면적" = b."연면적")
		where 	"거래구분" = '1'		-- 매매만 (전세,월세 제외)
		and     "계약년월" = '202508' and "번호" = 212
	--) group by "계약년월", "번호", "주택유형" having count("관리_건축물대장_PK") = 0 order by "계약년월" desc, "번호"
--) group by "주택유형"
;

select * from "실거래_단독다가구_분당구" where "거래구분" = '1';

----------------------------------------------------------------------------------------------------------------------------------------------------------------
-- [실거래_상업업무용_분당구]
-- 1) 용도 매핑 
--   . 국토부 실거래 공개에서 상업·업무용은 “주택·토지·오피스텔·산업용 및 기타(가설건축물 등)를 제외한 건축물”로, 건축물 주용도는 “근린생활시설(1·2종), 판매시설, 교육연구시설, 숙박시설, 업무시설, 기타(운동·종교·노유자 등)” 7종류로 재분류해서 사용합니다.
--   . 즉 상업·업무용 실거래에 해당하는 건축물대장은 근린생활시설뿐 아니라 판매시설, 업무시설, 숙박시설, 교육연구시설, 노유자시설 등 여러 용도가 포함됩니다.
-- 2) 면적 매핑 
--   . 매매의 대지면적과 대장의 대지_면적을 비교 (대지면적이 0인 경우 포함)
--   . 매매의 전용면적과 대장의 연면적을 비교
--   . 공동주택·집합건물처럼 대지권 지분으로만 토지를 나누는 유형은 개별 호별 “대지면적”을 비워두거나 0으로 처리하는 사례가 있습니다.
--   . 행정기관·시스템 간 연계가 불완전하거나 토지대장·건축물대장상의 대지면적이 자동 매핑되지 않은 경우에도 기본값 0으로 남을 수 있습니다.
----------------------------------------------------------------------------------------------------------------------------------------------------------------
create or replace function "상업용_용도매핑체크" ("매매_유형" TEXT, "매매_용도지역" TEXT, "매매_건축물주용도" TEXT, "건물_주용도" TEXT, "건물_기타용도" TEXT)
returns boolean as $$
begin
	-- 단독주택, 교육연구시설 제외
	if "건물_주용도" in ('단독주택', '교육연구시설') then
		return false;
	elsif "건물_주용도" = '공동주택' and "건물_기타용도" = '아파트' then
		return false;
	end if;
	return true;
end;
$$ language plpgsql;


--select "유형", avg("건수") as "평균매핑건수" from (
	select "계약년월", "번호", "유형",  COUNT("관리_건축물대장_PK") as "건수" from (
		select t.*, b.*
		from   "실거래_상업업무용_분당구" t 
		       left outer join  "건축물대장" b
				--on    (t."시군구명" = b."시군구명" and t."지번" = b."번지")
				--on    (t."시군구명" = b."시군구명" and t."지번" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치"))
				--on    (t."시군구명" = b."시군구명" and t."지번" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치") and "상업용_용도매핑체크"(t."유형", t."용도지역", t."건축물주용도", b."주_용도_코드_명", b."기타_용도"))
				on    (t."시군구명" = b."시군구명" and t."지번" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치") and "상업용_용도매핑체크"(t."유형", t."용도지역", t."건축물주용도", b."주_용도_코드_명", b."기타_용도") and t."대지면적" = b."대지_면적")
		where  1=1
		and    t."계약년월" = '202312' and t."번호" = 4707
		order by t."계약년월" desc, t."번호"
	) group by "계약년월", "번호", "유형" having COUNT("관리_건축물대장_PK") = 0 order by "계약년월" desc, "번호"
--) group by "유형"
;

select *
from   "실거래_상업업무용_분당구" t 
where  t."계약년월" = '202009'
order by t."전용면적"
;

-- 6층, 전용면적=766.19, 대지면적=0
-- 사무소	업무시설(사무소)	897.990000000
-- 연구소	교육연구시설(연구소)	258.830000000
select *
from   "건축물대장_층별개요"
where  "관리_건축물대장_PK" in (
'10891100204733',
'10891100204734',
'10891100204735',
'10891100204736',
'10891100204737',
'10891100204739',
'10891100204740',
'10891100204741',
'10891100204742',
'10891100222844',
'10891100222858',
'10891100222893',
'10891100222943',
'10891100222981',
'10891100228340',
'10891100228357',
'10891100228369',
'10891100228380',
'10891100228482',
'10891100228491',
'10891100228504',
'10891100228577',
'10891100228617',
'10891100238602',
'10891100238603',
'10891100239624',
'10891100240343',
'10891100240344'
)
and "층_번호_명" = '6층'
order by "면적"
;

-- 14,072건
select count(*) from "실거래_상업업무용_분당구" t ;



----------------------------------------------------------------------------------------------------------------------------------------------------------------
-- [실거래_공장창고_분당구]
----------------------------------------------------------------------------------------------------------------------------------------------------------------
select t.*, b.*
from   "실거래_공장창고_분당구" t
       left outer join "건축물대장" b
       --on (t."시군구명" = b."시군구명" and t."지번" = b."번지")
       --on (t."시군구명" = b."시군구명" and t."지번" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치"))
       --on (t."시군구명" = b."시군구명" and t."지번" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치") and b."주_용도_코드_명" <> '공동주택')
       on (t."시군구명" = b."시군구명" and t."지번" = b."번지" and "도로명체크"(t."도로명", b."도로명_대지_위치") and b."주_용도_코드_명" <> '공동주택' and t."전용면적" = b."연면적")
order by "계약년월" desc, "번호"
;